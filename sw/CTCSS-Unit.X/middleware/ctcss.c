/*
\author         Oliver Blaser
\date           16.08.2021
\copyright      GNU GPLv3 - Copyright (c) 2021 Oliver Blaser
*/

#include "../driver/hardware_16F1825.h"
#include "ctcss.h"


const uint16_t ccpValue[] = // CTCSS tone look up table for CCPx values
{
    14925, 14430, 13908, 13441, 12987,  //  67.0  69.3  71.9  74.4  77.0
    12547, 12121, 11710, 11299, 10929,  //  79.7  82.5  85.4  88.5  91.5
    10549, 10267, 10000,  9662,  9328,  //  94.8  97.4 100.0 103.5 107.2
     9017,  8711,  8418,  8130,  7855,  // 110.9 114.8 118.8 123.0 127.3
     7587,  7326,  7077,  6840,  6605,  // 131.8 136.5 141.3 146.2 151.4
     6382,  6258,  6165,  6042,  5956,  // 156.7 159.8 162.2 165.5 167.9
     5838,  5754,  5640,  5559,  5450,  // 171.3 173.8 177.3 179.9 183.5
     5371,  5266,  5187,  5086,  5013,  // 186.2 189.9 192.8 196.6 199.5
     4914,  4843,  4746,  4585,  4431,  // 203.5 206.5 210.7 218.1 225.7
     4365,  4281,  4136,  3995,  3935   // 229.1 233.6 241.8 250.3 254.1
};
// Formula: f_CTCSS = f_TIM1CS / (2 * CCPR2) = Fosc/4 / (2 * CCPR2)
//         <=> CCP2 = Fosc / (8 * f_CTCSS) = 8MHz / (8 * f_CTCSS)
//             CCP2 = 1MHz / f_CTCSS
//
// Calculate the lookup values with Octave:
// CCP2=round(10^6./[67.0,69.3,71.9,74.4,77.0;,79.7,82.5,85.4,88.5,91.5;,94.8,97.4,100.0,103.5,107.2;,110.9,114.8,118.8,123.0,127.3;,131.8,136.5,141.3,146.2,151.4;,156.7,159.8,162.2,165.5,167.9;,171.3,173.8,177.3,179.9,183.5;,186.2,189.9,192.8,196.6,199.5;,203.5,206.5,210.7,218.1,225.7;,229.1,233.6,241.8,250.3,254.1])


void CTCSS_setTone(uint8_t ctcssIdx)
{
    --ctcssIdx;
    
    if(ctcssIdx < (sizeof(ccpValue) / sizeof(ccpValue[0])))
    {
        CCPR2H = (uint8_t)(ccpValue[ctcssIdx] >> 8);
        CCPR2L = (uint8_t)ccpValue[ctcssIdx];
        
        //CCP2CON &= ~0x0F;
        CCP2CON |= 0b00000010;
        CCP2IE = 1;
    }
    else
    {
        CCP2IE = 0;
        CCP2CON &= ~0x0F;
    }
}
